<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>three-hero — particles</title>
  <style>
    html,body{margin:0;height:100%;background:#000;}
    #hero{position:relative;height:100vh;overflow:hidden}
    #webgl{position:absolute;inset:0;width:100%;height:100%;display:block}
    h1{
      position:absolute;left:8%;bottom:12%;z-index:2;margin:0;
      font:700 clamp(28px,6vw,96px)/1 system-ui,'Noto Sans JP',sans-serif;
      color:#e8ecff;letter-spacing:.02em;mix-blend-mode:screen
    }
    .hud{
      position:absolute;left:12px;top:12px;z-index:3;
      padding:8px 10px;border-radius:10px;
      color:#cfe2ff;background:rgba(20,24,36,.55);
      backdrop-filter:blur(8px);font:500 12px/1.3 system-ui,'Noto Sans JP',sans-serif
    }
  </style>
</head>
<body>
  <section id="hero">
    <canvas id="webgl"></canvas>
    <h1>Your Brand</h1>
    <div class="hud" id="hud">Loading…</div>
  </section>

  <script>
  (function(){
    const hud = document.getElementById('hud');

    function log(msg){ hud.textContent = msg; }

    function loadScript(src){
      return new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = src;
        s.async = false; // 順序厳守
        s.onload = ()=>resolve(src);
        s.onerror = ()=>reject(new Error('NG ' + src));
        document.head.appendChild(s);
      });
    }

    // CDN候補（jsDelivr→unpkg）
    const CORE = [
      'https://cdn.jsdelivr.net/npm/three@0.164.0/build/three.min.js',
      'https://unpkg.com/three@0.164.0/build/three.min.js'
    ];
    const EXAMPLES = [
      // 順序厳守
      [
        'https://cdn.jsdelivr.net/npm/three@0.164.0/examples/js/postprocessing/EffectComposer.js',
        'https://cdn.jsdelivr.net/npm/three@0.164.0/examples/js/postprocessing/RenderPass.js',
        'https://cdn.jsdelivr.net/npm/three@0.164.0/examples/js/shaders/CopyShader.js',
        'https://cdn.jsdelivr.net/npm/three@0.164.0/examples/js/shaders/LuminosityHighPassShader.js',
        'https://cdn.jsdelivr.net/npm/three@0.164.0/examples/js/postprocessing/UnrealBloomPass.js',
      ],
      [
        'https://unpkg.com/three@0.164.0/examples/js/postprocessing/EffectComposer.js',
        'https://unpkg.com/three@0.164.0/examples/js/postprocessing/RenderPass.js',
        'https://unpkg.com/three@0.164.0/examples/js/shaders/CopyShader.js',
        'https://unpkg.com/three@0.164.0/examples/js/shaders/LuminosityHighPassShader.js',
        'https://unpkg.com/three@0.164.0/examples/js/postprocessing/UnrealBloomPass.js',
      ]
    ];

    async function loadThree(){
      // core を試行
      let ok = false, usedCore = '';
      for(const url of CORE){
        try{ await loadScript(url); usedCore = url; ok = true; break; }catch(e){}
      }
      if(!ok || !window.THREE){ log('three.js 読込失敗'); return false; }
      log('three.js loaded: ' + usedCore.replace(/^https?:\/\//,''));

      // examples を試行（セットごと）
      let usedSet = null;
      for(const set of EXAMPLES){
        try{
          for(const url of set){ await loadScript(url); }
          usedSet = set[0].includes('cdn.jsdelivr.net') ? 'jsDelivr' : 'unpkg';
          break;
        }catch(e){
          // 失敗したら次の候補セットへ
        }
      }
      if(!window.THREE.EffectComposer || !window.THREE.UnrealBloomPass){
        log('postprocessing 読込失敗（Bloomなしで実行）');
      }else{
        log('postprocessing loaded: ' + usedSet);
      }
      return true;
    }

    function start(){
      const canvas = document.getElementById('webgl');
      const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
      renderer.setSize(innerWidth, innerHeight);

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 100);
      camera.position.set(0,0,6);

      // ライト
      scene.add(new THREE.HemisphereLight(0xffffff, 0x202040, 0.9));
      const dir = new THREE.DirectionalLight(0xffffff, 0.55);
      dir.position.set(3,3,3); scene.add(dir);

      // 粒子
      const COUNT = 3200;
      const g = new THREE.BufferGeometry();
      const pos = new Float32Array(COUNT*3);
      for(let i=0;i<COUNT;i++){
        pos[i*3+0]=(Math.random()-0.5)*12;
        pos[i*3+1]=(Math.random()-0.5)*8;
        pos[i*3+2]=(Math.random()-0.5)*10;
      }
      g.setAttribute('position', new THREE.BufferAttribute(pos,3));
      const points = new THREE.Points(
        g,
        new THREE.PointsMaterial({ color:0x66ccff, size:0.05, transparent:true, opacity:0.9 })
      );
      scene.add(points);

      // ガラス板
      const plate = new THREE.Mesh(
        new THREE.PlaneGeometry(3.2, 1.8, 32, 32),
        new THREE.MeshPhysicalMaterial({
          color:0xffffff, metalness:0, roughness:0.08,
          transmission:0.72, thickness:0.4, transparent:true
        })
      );
      plate.position.z = -0.5;
      scene.add(plate);

      // Bloom（読み込めていなければ通常描画）
      let useComposer = false, composer = null;
      if(THREE.EffectComposer && THREE.RenderPass && THREE.UnrealBloomPass){
        composer = new THREE.EffectComposer(renderer);
        composer.addPass(new THREE.RenderPass(scene, camera));
        const bloom = new THREE.UnrealBloomPass(
          new THREE.Vector2(innerWidth, innerHeight),
          0.5, 0.85, 0.8
        );
        composer.addPass(bloom);
        useComposer = true;
      }

      // パララックス
      const mouse={x:0,y:0};
      addEventListener('pointermove', e=>{
        mouse.x=(e.clientX/innerWidth)-0.5;
        mouse.y=(e.clientY/innerHeight)-0.5;
      });

      // ループ
      let t=0; const clock=new THREE.Clock();
      function tick(){
        const dt=clock.getDelta(); t+=dt;

        const p = points.geometry.attributes.position;
        for(let i=0;i<p.count;i++){
          const iz=i*3+2, iy=i*3+1;
          const z=p.array[iz];
          p.array[iy] += Math.sin(t*0.6 + z)*0.0006;
        }
        p.needsUpdate = true;

        points.rotation.y += dt*0.05;

        camera.position.x += (mouse.x*0.8 - camera.position.x)*0.05;
        camera.position.y += (-mouse.y*0.6 - camera.position.y)*0.05;
        camera.lookAt(0,0,0);

        if(useComposer){ composer.render(); } else { renderer.render(scene,camera); }
        requestAnimationFrame(tick);
      }
      tick();

      // リサイズ
      addEventListener('resize', ()=>{
        const w=innerWidth, h=innerHeight;
        renderer.setSize(w,h);
        if(useComposer) composer.setSize(w,h);
        camera.aspect = w/h;
        camera.updateProjectionMatrix();
      });
    }

    (async function init(){
      const ok = await loadThree();
      if(!ok || !window.THREE){ log('読み込みに失敗しました'); return; }
      try{
        start();
        log(hud.textContent + ' — running');
      }catch(e){
        console.error(e);
        log('初期化エラー: ' + e.message);
      }
    })();
  })();
  </script>
</body>
</html>
